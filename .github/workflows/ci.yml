name: CI

on:
  pull_request:
  push:
    branches: [main, develop, 'release/**']

permissions:
  contents: write
  checks: write

env:
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true

jobs:
  build-test-pack:
    name: Build, Test, Pack
    runs-on: windows-latest
    outputs:
      version: ${{ steps.resolve-version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0 # Nerdbank.GitVersioning needs full history

      - name: Setup .NET
        uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9 # v4.3.1
        with:
          dotnet-version: '10.0.x'
          dotnet-quality: ga

      - name: Restore
        run: dotnet restore src/ManicTimeMcp.slnx --force

      - name: Build
        run: dotnet build src/ManicTimeMcp.slnx -c Release -warnaserror --no-restore

      - name: Test
        run: >-
          dotnet test --solution src/ManicTimeMcp.slnx
          -c Release
          --no-build
          --results-directory TestResults
          --
          --report-trx
          --coverage
          --coverage-output-format cobertura

      - name: Test report
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Test Results
          path: 'TestResults/**/*.trx'
          reporter: dotnet-trx

      - name: Coverage summary
        if: always()
        shell: pwsh
        run: |
          $coberturaFiles = Get-ChildItem -Path TestResults -Filter '*.cobertura.xml' -Recurse -ErrorAction SilentlyContinue
          if (-not $coberturaFiles -or $coberturaFiles.Count -eq 0) {
            Write-Host 'No Cobertura coverage files found â€” skipping summary.'
            exit 0
          }
          foreach ($file in $coberturaFiles) {
            [xml]$xml = Get-Content $file.FullName
            $lineRate = [math]::Round([double]$xml.coverage.'line-rate' * 100, 1)
            $branchRate = [math]::Round([double]$xml.coverage.'branch-rate' * 100, 1)
            "## Code Coverage`n" | Out-File -Append $env:GITHUB_STEP_SUMMARY
            "| Metric | Value |" | Out-File -Append $env:GITHUB_STEP_SUMMARY
            "|--------|-------|" | Out-File -Append $env:GITHUB_STEP_SUMMARY
            "| Line coverage | ${lineRate}% |" | Out-File -Append $env:GITHUB_STEP_SUMMARY
            "| Branch coverage | ${branchRate}% |" | Out-File -Append $env:GITHUB_STEP_SUMMARY
            Write-Host "Line coverage: ${lineRate}%, Branch coverage: ${branchRate}%"
          }

      - name: Pack
        shell: pwsh
        run: dotnet pack src/ManicTimeMcp.slnx -c Release --no-restore -o '${{ runner.temp }}\packages'

      - name: Resolve version
        id: resolve-version
        shell: pwsh
        run: |
          $nupkg = Get-ChildItem '${{ runner.temp }}\packages\ManicTimeMcp.*.nupkg' | Select-Object -First 1
          $version = $nupkg.BaseName -replace '^ManicTimeMcp\.',''
          "version=$version" >> $env:GITHUB_OUTPUT

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: test-results
          path: TestResults/**
          retention-days: 14

      - name: Upload packages
        if: success()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: packages
          path: ${{ runner.temp }}/packages/*.nupkg
          retention-days: 14

  release:
    name: GitHub Release
    needs: build-test-pack
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release/'))
    runs-on: ubuntu-latest
    steps:
      - name: Download packages
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: packages
          path: packages

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ needs.build-test-pack.outputs.version }}"
          PRERELEASE=""
          [[ "$VERSION" == *-* ]] && PRERELEASE="--prerelease"
          gh release create "v${VERSION}" packages/* \
            --title "v${VERSION}" \
            --generate-notes \
            $PRERELEASE

      - name: Publish to NuGet
        run: >-
          dotnet nuget push packages/*.nupkg
          --api-key ${{ secrets.NUGET_API_KEY }}
          --source https://api.nuget.org/v3/index.json
          --skip-duplicate
