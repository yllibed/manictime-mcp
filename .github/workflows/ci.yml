name: CI

on:
  pull_request:
  push:
    branches: [main, develop, 'release/**']

permissions:
  contents: read
  checks: write

env:
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true

jobs:
  build-test-pack:
    name: Build, Test, Pack
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0 # Nerdbank.GitVersioning needs full history

      - name: Setup .NET
        uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9 # v4.3.1
        with:
          dotnet-version: '10.0.x'
          dotnet-quality: ga

      - name: Restore
        run: dotnet restore src/ManicTimeMcp.slnx

      - name: Build
        run: dotnet build src/ManicTimeMcp.slnx -c Release -warnaserror --no-restore

      - name: Test
        run: >-
          dotnet test --solution src/ManicTimeMcp.slnx
          -c Release
          --no-build
          --results-directory ${{ runner.temp }}/test-results
          --
          --report-trx
          --coverage
          --coverage-output-format cobertura

      - name: Test report
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Test Results
          path: '${{ runner.temp }}/test-results/**/*.trx'
          reporter: dotnet-trx

      - name: Coverage summary
        if: always()
        shell: pwsh
        run: |
          $coberturaFiles = Get-ChildItem -Path "${{ runner.temp }}/test-results" -Filter "coverage.cobertura.xml" -Recurse -ErrorAction SilentlyContinue
          if (-not $coberturaFiles -or $coberturaFiles.Count -eq 0) {
            Write-Host "No Cobertura coverage files found â€” skipping summary."
            exit 0
          }
          foreach ($file in $coberturaFiles) {
            [xml]$xml = Get-Content $file.FullName
            $lineRate = [math]::Round([double]$xml.coverage.'line-rate' * 100, 1)
            $branchRate = [math]::Round([double]$xml.coverage.'branch-rate' * 100, 1)
            @"
          ## Code Coverage

          | Metric | Value |
          |--------|-------|
          | Line coverage | ${lineRate}% |
          | Branch coverage | ${branchRate}% |
          "@ | Out-File -Append $env:GITHUB_STEP_SUMMARY
            Write-Host "Line coverage: ${lineRate}%, Branch coverage: ${branchRate}%"
          }

      - name: Pack (dry-run)
        run: dotnet pack src/ManicTimeMcp.slnx -c Release --no-build -o ${{ runner.temp }}/packages

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: test-results
          path: ${{ runner.temp }}/test-results/**
          retention-days: 14

      - name: Upload packages
        if: success()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: packages
          path: ${{ runner.temp }}/packages/*.nupkg
          retention-days: 14
